<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <title id="page-title">ROM Manager // Admin</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #10b981;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --card-bg: #1e293b;
                --text-main: #f1f5f9;
                --text-muted: #94a3b8;
                --border: #334155;
            }
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        h1, h2, h3 { margin-top: 0; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        input[type="text"], input[type="password"], select, input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text-main);
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            color: white;
        }

        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; opacity: 0.7; }

        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: var(--danger-hover); }

        .btn-sm { padding: 6px 12px; font-size: 0.85em; }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        #drop-zone {
            border: 2px dashed var(--border);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        #drop-zone.dragover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }

        #progress-container {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .progress-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .progress-track {
            background: var(--border);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.2s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 15px;
        }
        .stat-item strong { display: block; color: var(--text-main); font-size: 1.1em; }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .file-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            position: relative;
        }

        .file-card .tag {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--border);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: bold;
        }
        .file-card .tag.vanilla { background: #dbeafe; color: #1e40af; }
        .file-card .tag.gapps { background: #dcfce7; color: #166534; }

        .file-name { font-weight: 600; margin-bottom: 5px; word-break: break-all; padding-right: 60px; }
        .file-meta { font-size: 0.85em; color: var(--text-muted); margin-bottom: 10px; }
        .file-actions { display: flex; gap: 8px; }

        .category-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .category-badge {
            padding: 8px 16px;
            border-radius: 6px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 0.9em;
        }
        .category-badge strong { color: var(--primary); }

        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 id="admin-title">ROM Manager</h1>
        <div style="text-align: right;">
            <small style="color: var(--text-muted)">Server Status: <span id="server-status">Checking...</span></small>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="card">
        <h3>ðŸ”‘ Authentication</h3>
        <input type="password" id="api-key" placeholder="Enter Admin API Key" autocomplete="current-password">
        <small class="text-muted">Saved locally for convenience.</small>
    </div>

    <!-- Category Info -->
    <div class="card">
        <h3>ðŸ“Š Category Limits</h3>
        <div id="category-info" class="category-info">
            <p style="color: var(--text-muted)">Loading configuration...</p>
        </div>
    </div>

    <!-- Upload Card -->
    <div class="card">
        <h3>ðŸ“¤ Upload New Build</h3>
        
        <form id="upload-form">
            <div class="upload-grid">
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:600">Category</label>
                    <select id="category-select">
                        <!-- Dynamically populated -->
                    </select>
                </div>
            </div>

            <div id="drop-zone">
                <p style="margin:0; color:var(--text-muted)">Drag & Drop ZIP file here or click to select</p>
                <input type="file" id="file-input" accept=".zip" style="display:none">
            </div>
            
            <div style="font-size: 0.9em; margin-bottom: 15px;" id="selected-file-name"></div>

            <button type="submit" class="btn btn-primary" id="upload-btn">Start Upload</button>
        </form>

        <!-- Progress Section -->
        <div id="progress-container">
            <div class="progress-meta">
                <span id="status-text">Uploading...</span>
                <span id="percent-text">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span id="speed-text">0 MB/s</span>
                    <strong>Upload Speed</strong>
                </div>
                <div class="stat-item">
                    <span id="uploaded-text">0 / 0 MB</span>
                    <strong>Data Sent</strong>
                </div>
                <div class="stat-item">
                    <span id="eta-text">--:--</span>
                    <strong>Time Remaining</strong>
                </div>
            </div>

            <button type="button" class="btn btn-danger" id="cancel-btn">Cancel Upload</button>
        </div>
    </div>

    <!-- File List -->
    <h3>ðŸ“‚ Existing Builds</h3>
    <div id="file-list" class="file-grid">
        <!-- Cards injected via JS -->
    </div>
</div>

<div id="toast-container"></div>

<script>
    // State
    let appConfig = null;
    
    const els = {
        apiKey: document.getElementById('api-key'),
        form: document.getElementById('upload-form'),
        fileInput: document.getElementById('file-input'),
        dropZone: document.getElementById('drop-zone'),
        fileName: document.getElementById('selected-file-name'),
        uploadBtn: document.getElementById('upload-btn'),
        progressContainer: document.getElementById('progress-container'),
        progressBar: document.getElementById('progress-bar'),
        cancelBtn: document.getElementById('cancel-btn'),
        fileList: document.getElementById('file-list'),
        categorySelect: document.getElementById('category-select'),
        categoryInfo: document.getElementById('category-info'),
        serverStatus: document.getElementById('server-status'),
        status: document.getElementById('status-text'),
        percent: document.getElementById('percent-text'),
        speed: document.getElementById('speed-text'),
        uploaded: document.getElementById('uploaded-text'),
        eta: document.getElementById('eta-text'),
    };

    let currentXhr = null;
    let lastUploadTime = 0;
    let lastLoaded = 0;

    // Initialization
    document.addEventListener('DOMContentLoaded', async () => {
        // Load API Key from localStorage
        const savedKey = localStorage.getItem('rom_api_key');
        if (savedKey) els.apiKey.value = savedKey;

        // Load configuration first
        await loadConfig();
        
        // Then fetch files
        fetchFiles();
        
        // Check server health
        checkHealth();

        // Drag & Drop setup
        els.dropZone.addEventListener('click', () => els.fileInput.click());
        els.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); els.dropZone.classList.add('dragover'); });
        els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.remove('dragover'));
        els.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            els.dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
        });
        els.fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFileSelect(e.target.files[0]);
        });

        // Key Save
        els.apiKey.addEventListener('input', (e) => localStorage.setItem('rom_api_key', e.target.value));
    });

    async function loadConfig() {
        try {
            const res = await fetch('/api/config');
            if (!res.ok) throw new Error('Failed to load config');
            appConfig = await res.json();

            // Update title
            document.title = appConfig.app_name + ' // Admin';
            document.getElementById('admin-title').textContent = appConfig.app_name + ' Manager';

            // Populate category select
            els.categorySelect.innerHTML = appConfig.categories.map(cat => 
                `<option value="${cat.name}">${cat.display_name}</option>`
            ).join('');

            // Show category info
            els.categoryInfo.innerHTML = appConfig.categories.map(cat => `
                <div class="category-badge">
                    <strong>${cat.display_name}</strong>: ${cat.file_count}/${cat.max_files} files
                </div>
            `).join('');

        } catch (err) {
            console.error('Failed to load config:', err);
            showToast('Failed to load configuration', 'error');
        }
    }

    async function checkHealth() {
        try {
            const res = await fetch('/health');
            if (res.ok) {
                els.serverStatus.textContent = 'Online';
                els.serverStatus.style.color = 'var(--success)';
            } else {
                throw new Error('Not OK');
            }
        } catch {
            els.serverStatus.textContent = 'Offline';
            els.serverStatus.style.color = 'var(--danger)';
        }
    }

    function handleFileSelect(file) {
        els.fileInput.files = createFileList(file);
        els.fileName.textContent = `Selected: ${file.name} (${formatSize(file.size)})`;
    }

    // Upload Logic
    els.form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const file = els.fileInput.files[0];
        const key = els.apiKey.value.trim();
        const category = els.categorySelect.value;

        if (!file) return showToast('Please select a file', 'error');
        if (!key) return showToast('API Key is required', 'error');

        startUpload(file, category, key);
    });

    function startUpload(file, category, key) {
        els.uploadBtn.disabled = true;
        els.progressContainer.style.display = 'block';
        els.fileName.style.display = 'none';
        resetStats();
        
        const formData = new FormData();
        formData.append('zipfile', file);
        formData.append('category', category);

        currentXhr = new XMLHttpRequest();
        // Send category in query param so server can validate it before reading body
        currentXhr.open('POST', `/upload?category=${encodeURIComponent(category)}`, true);
        currentXhr.setRequestHeader('X-API-Key', key);

        const startTime = Date.now();
        lastUploadTime = startTime;
        lastLoaded = 0;

        currentXhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const now = Date.now();
                const total = e.total;
                const loaded = e.loaded;
                const percent = ((loaded / total) * 100).toFixed(1);

                els.progressBar.style.width = percent + '%';
                els.percent.textContent = percent + '%';
                els.uploaded.textContent = `${formatSize(loaded)} / ${formatSize(total)}`;

                if (now - lastUploadTime >= 500) {
                    const timeDiff = (now - lastUploadTime) / 1000;
                    const bytesDiff = loaded - lastLoaded;
                    const speedBytesPerSec = bytesDiff / timeDiff;

                    const remainingBytes = total - loaded;
                    const secondsRemaining = speedBytesPerSec > 0 ? remainingBytes / speedBytesPerSec : 0;

                    els.speed.textContent = `${formatSpeed(speedBytesPerSec)}`;
                    els.eta.textContent = formatTime(secondsRemaining);

                    lastUploadTime = now;
                    lastLoaded = loaded;
                }
            }
        };

        currentXhr.onload = () => {
            if (currentXhr.status === 200) {
                const successMsg = appConfig?.text?.upload_success || 'Upload Successful!';
                showToast(successMsg, 'success');
                uploadCleanup();
                loadConfig(); // Refresh category counts
                fetchFiles();
            } else {
                let errorMsg = appConfig?.text?.upload_failed || 'Upload failed';
                try {
                    const resp = JSON.parse(currentXhr.responseText);
                    errorMsg = resp.error || errorMsg;
                } catch {}
                showToast(`Error: ${errorMsg}`, 'error');
                uploadCleanup();
            }
        };

        currentXhr.onerror = () => {
            showToast('Network Error', 'error');
            uploadCleanup();
        };

        currentXhr.onabort = () => {
            showToast('Upload Cancelled', 'error');
            uploadCleanup();
        };

        currentXhr.send(formData);
    }

    els.cancelBtn.addEventListener('click', () => {
        if (currentXhr) {
            currentXhr.abort();
            currentXhr = null;
        }
    });

    function uploadCleanup() {
        els.uploadBtn.disabled = false;
        els.progressContainer.style.display = 'none';
        els.fileName.style.display = 'block';
        els.fileInput.value = '';
        els.fileName.textContent = '';
        currentXhr = null;
    }

    // List Logic
    function fetchFiles() {
        fetch('/list')
            .then(res => res.json())
            .then(data => {
                // Handle { files: [...] } or [...] or null
                let files = [];
                if (data && Array.isArray(data.files)) {
                    files = data.files;
                } else if (Array.isArray(data)) {
                    files = data;
                }
                
                els.fileList.innerHTML = '';
                if (files.length === 0) {
                    const msg = appConfig?.text?.no_files_found || 'No files found on server.';
                    els.fileList.innerHTML = `<p style="color:var(--text-muted)">${msg}</p>`;
                    return;
                }
                files.forEach(file => {
                    const card = document.createElement('div');
                    card.className = 'file-card';
                    const displayName = getCategoryDisplayName(file.category);
                    card.innerHTML = `
                        <span class="tag ${file.category}">${displayName}</span>
                        <div class="file-name">${file.filename}</div>
                        <div class="file-meta">
                            Size: ${file.size} â€¢ Uploaded: ${file.updated_at}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteFile('${file.category}', '${file.filename}')">Delete</button>
                        </div>
                    `;
                    els.fileList.appendChild(card);
                });
            })
            .catch(err => {
                console.error("Failed to fetch list", err);
                els.fileList.innerHTML = '<p style="color:var(--danger)">Failed to load file list.</p>';
            });
    }

    function getCategoryDisplayName(catName) {
        if (!appConfig) return catName;
        const cat = appConfig.categories.find(c => c.name === catName);
        return cat ? cat.display_name : catName;
    }

    // Delete file
    window.deleteFile = function(category, filename) {
        const key = els.apiKey.value.trim();
        if (!key) return showToast('API Key is required', 'error');
        
        if (!confirm(`Delete ${filename}?`)) return;

        fetch(`/delete?category=${encodeURIComponent(category)}&filename=${encodeURIComponent(filename)}`, {
            method: 'DELETE',
            headers: { 'X-API-Key': key }
        })
        .then(res => {
            if (res.ok) {
                showToast('File deleted', 'success');
                loadConfig(); // Refresh counts
                fetchFiles();
            } else {
                return res.json().then(data => {
                    throw new Error(data.error || 'Delete failed');
                });
            }
        })
        .catch(err => {
            showToast(err.message, 'error');
        });
    };

    // Utilities
    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatSpeed(bytesPerSec) {
        return formatSize(bytesPerSec) + '/s';
    }

    function formatTime(seconds) {
        if (!isFinite(seconds) || seconds < 0) return "--:--";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}m ${s}s`;
    }

    function resetStats() {
        els.progressBar.style.width = '0%';
        els.percent.textContent = '0%';
        els.speed.textContent = 'Calculating...';
        els.eta.textContent = '--:--';
    }

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = msg;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    function createFileList(file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        return dt.files;
    }
</script>

</body>
</html>
